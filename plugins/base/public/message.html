{{template "head.html"}}

<h1>koushin</h1>

<p>
	<a href="/mailbox/{{.Mailbox.Name | pathescape}}?page={{.MailboxPage}}">
		Back
	</a>
</p>

<h2>
	{{if .Message.Envelope.Subject}}
		{{.Message.Envelope.Subject}}
	{{else}}
		(No subject)
	{{end}}
</h2>

<form method="post" action="{{.Message.Uid}}/move">
	<label for="move-to">Move to:</label>
	<select name="to" id="move-to">
		{{range .Mailboxes}}
			<option {{if eq .Name $.Mailbox.Name}}selected{{end}}>{{.Name}}</option>
		{{end}}
	</select>
	<input type="submit" value="Move">
</form>

<form method="post" action="{{.Message.Uid}}/delete">
	<input type="submit" value="Delete">
</form>

{{if .Flags}}
	<form method="post" action="{{.Message.Uid}}/flag">
		<p>Flags:</p>
		{{range $name, $has := .Flags}}
			{{if ismutableflag $name}}
				<input type="checkbox" name="flags" id="flag-{{$name}}"
					value="{{$name}}" {{if $has}}checked{{end}}>
				<label for="flag-{{$name}}">{{$name | formatflag}}</label>
				<br>
			{{else}}
				{{if $has}}
					<input type="hidden" name="flags" value="{{$name}}">
				{{end}}
			{{end}}
		{{end}}
		<input type="submit" value="Set flags">
	</form>
{{end}}

{{define "addr-list"}}
	{{range $i, $addr := .}}
		{{if $i}},{{end}}
		{{.PersonalName}}
		&lt;<a href="/compose?to={{.Address}}">{{.Address}}</a>&gt;
	{{end}}
{{end}}

<ul>
	<li>
		<strong>Date</strong>: {{.Message.Envelope.Date | formatdate}}
	</li>
	<li>
		<strong>From</strong>: {{template "addr-list" .Message.Envelope.From}}
	</li>
	<li>
		<strong>To</strong>: {{template "addr-list" .Message.Envelope.To}}
	</li>
	{{if .Message.Envelope.Cc}}
		<li>
			<strong>Cc</strong>: {{template "addr-list" .Message.Envelope.Cc}}
		</li>
	{{end}}
	{{if .Message.Envelope.Bcc}}
		<li>
			<strong>Bcc</strong>: {{template "addr-list" .Message.Envelope.Bcc}}
		</li>
	{{end}}
</ul>

{{define "message-part-tree"}}
	{{/* nested templates can't access the parent's context */}}
	{{$ = index . 0}}
	{{with index . 1}}
		<a
			{{if .IsText}}
				href="{{$.Message.Uid}}?part={{.PathString}}"
			{{else}}
				href="{{$.Message.Uid}}/raw?part={{.PathString}}"
			{{end}}
		>
			{{if eq $.PartPath .PathString}}<strong>{{end}}
			{{.String}}
			{{if eq $.PartPath .PathString}}</strong>{{end}}
		</a>
		{{if .Children}}
		<ul>
			{{range .Children}}
				<li>{{template "message-part-tree" (tuple $ .)}}</li>
			{{end}}
		</ul>
		{{end}}
	{{end}}
{{end}}

<p>Parts:</p>

{{template "message-part-tree" (tuple $ .Message.PartTree)}}

<hr>

{{if .Body}}
	<p><a href="{{.Message.Uid}}/reply?part={{.PartPath}}">Reply</a></p>
	<pre>{{.Body}}</pre>
{{else}}
	<p>Can't preview this message part.</p>
	<a href="{{.Message.Uid}}/raw?part={{.PartPath}}">Download</a>
{{end}}

{{template "foot.html"}}
